<div class="campaign-detail-container">
  <!-- Loading State -->
  @if (loading()) {
    <div class="loading-container">
      <mat-progress-bar mode="indeterminate"></mat-progress-bar>
      <p class="loading-text">Loading campaign details...</p>
    </div>
  }

  <!-- Error State -->
  @if (error()) {
    <div class="error-container">
      <mat-card class="error-card">
        <mat-card-content>
          <mat-icon color="warn">error</mat-icon>
          <h2>Error Loading Campaign</h2>
          <p>{{ error() }}</p>
          <button mat-raised-button color="primary" [routerLink]="['/dashboard/campaigns']">
            Back to Campaigns
          </button>
        </mat-card-content>
      </mat-card>
    </div>
  }

  <!-- Campaign Details -->
  @if (campaign() && !loading() && !error()) {
    <div class="campaign-content">
      <!-- Header -->
      <div class="campaign-header">
        <div class="campaign-title">
          <h1>
            <mat-icon [ngClass]="'icon-' + campaign()?.status">{{
              getTypeIcon(campaign()?.type || '')
            }}</mat-icon>
            {{ campaign()?.name }}
          </h1>
          <div class="campaign-badges">
            <span class="status-badge" [ngClass]="'status-' + campaign()?.status">
              {{ getStatusLabel(campaign()?.status || '') }}
            </span>
            <span class="type-badge">{{ getTypeLabel(campaign()?.type || '') }}</span>
          </div>
        </div>

        <div class="campaign-actions">
          <button
            mat-raised-button
            color="primary"
            [disabled]="isScrapingRunning()"
            (click)="runScraping()"
            class="run-scraping-button"
          >
            <mat-icon>cloud_download</mat-icon>
            Run Scraping Now
          </button>
          <button mat-stroked-button [routerLink]="['/dashboard/campaigns']">
            <mat-icon>arrow_back</mat-icon>
            Back to Campaigns
          </button>
        </div>
      </div>

      <!-- Scraping Progress Section -->
      @if (scrapingProgress()) {
        <mat-card class="scraping-card">
          <mat-card-header>
            <mat-icon mat-card-avatar color="primary">analytics</mat-icon>
            <mat-card-title>Scraping Progress</mat-card-title>
            <mat-card-subtitle>
              {{ getScrapingStatusText() }}
            </mat-card-subtitle>
          </mat-card-header>

          <mat-card-content>
            <!-- Overall Progress -->
            <div class="progress-container">
              <h3>Overall Progress: {{ scrapingProgress()?.progress }}%</h3>
              <mat-progress-bar
                [mode]="isScrapingRunning() ? 'determinate' : 'determinate'"
                [value]="scrapingProgress()?.progress"
                class="overall-progress"
              >
              </mat-progress-bar>
            </div>

            <!-- Progress Tags -->
            <div class="progress-tags">
              @if ((scrapingProgress()?.hashtags?.total ?? 0) > 0) {
                <div
                  class="progress-tag"
                  [class.in-progress]="scrapingProgress()?.hashtags?.inProgress"
                >
                  <mat-icon>tag</mat-icon>
                  <span class="tag-label"
                    >Hashtags: {{ scrapingProgress()?.hashtags?.completed }}/{{
                      scrapingProgress()?.hashtags?.total
                    }}</span
                  >
                  <mat-progress-bar
                    mode="determinate"
                    [value]="
                      getProgressPercent(
                        scrapingProgress()?.hashtags?.completed || 0,
                        scrapingProgress()?.hashtags?.total || 0
                      )
                    "
                    class="tag-progress"
                  >
                  </mat-progress-bar>
                </div>
              }

              @if ((scrapingProgress()?.search?.total ?? 0) > 0) {
                <div
                  class="progress-tag"
                  [class.in-progress]="scrapingProgress()?.search?.inProgress"
                >
                  <mat-icon>search</mat-icon>
                  <span class="tag-label"
                    >Keywords: {{ scrapingProgress()?.search?.completed }}/{{
                      scrapingProgress()?.search?.total
                    }}</span
                  >
                  <mat-progress-bar
                    mode="determinate"
                    [value]="
                      getProgressPercent(
                        scrapingProgress()?.search?.completed || 0, 
                        scrapingProgress()?.search?.total || 0
                      )
                    "
                    class="tag-progress"
                  >
                  </mat-progress-bar>
                </div>
              }

              @if ((scrapingProgress()?.users?.total ?? 0) > 0) {
                <div
                  class="progress-tag"
                  [class.in-progress]="scrapingProgress()?.users?.inProgress"
                >
                  <mat-icon>person</mat-icon>
                  <span class="tag-label"
                    >Users: {{ scrapingProgress()?.users?.completed }}/{{
                      scrapingProgress()?.users?.total
                    }}</span
                  >
                  <mat-progress-bar
                    mode="determinate"
                    [value]="
                      getProgressPercent(
                        scrapingProgress()?.users?.completed || 0, 
                        scrapingProgress()?.users?.total || 0
                      )
                    "
                    class="tag-progress"
                  >
                  </mat-progress-bar>
                </div>
              }
            </div>

            <!-- Metrics -->
            @if (hasScrapingMetrics()) {
              <div class="metrics-container">
                <div class="metric">
                  <span class="metric-value">{{ scrapingProgress()?.metrics?.totalScraped }}</span>
                  <span class="metric-label">Total Scraped</span>
                </div>

                <div class="metric">
                  <span class="metric-value">{{ scrapingProgress()?.metrics?.saved }}</span>
                  <span class="metric-label">Saved</span>
                </div>

                @if ((scrapingProgress()?.metrics?.errors || 0) > 0) {
                  <div class="metric">
                    <span class="metric-value error-text">{{ scrapingProgress()?.metrics?.errors }}</span>
                    <span class="metric-label">Errors</span>
                  </div>
                }
              </div>
            }
          </mat-card-content>
        </mat-card>
      }

      <!-- Campaign Details Card -->
      <mat-card class="details-card">
        <mat-card-content>
          <div class="campaign-info">
            <div class="info-section">
              <h3>Campaign Details</h3>
              @if (campaign()?.description) {
                <p>{{ campaign()?.description }}</p>
              }

              <div class="info-grid">
                <div class="info-item">
                  <strong>Status:</strong> {{ getStatusLabel(campaign()?.status || '') }}
                </div>
                <div class="info-item">
                  <strong>Created:</strong> {{ campaign()?.createdAt | date : 'mediumDate' }}
                </div>
                <div class="info-item">
                  <strong>Start Date:</strong> {{ campaign()?.startDate | date : 'mediumDate' }}
                </div>
                <div class="info-item">
                  <strong>End Date:</strong> {{ campaign()?.endDate | date : 'mediumDate' }}
                </div>
                <div class="info-item">
                  <strong>Max Tweets:</strong> {{ campaign()?.maxTweets || 'Unlimited' }}
                </div>
                <div class="info-item">
                  <strong>Analysis:</strong>
                  {{ campaign()?.sentimentAnalysis ? 'Sentiment Analysis Enabled' : 'Basic Analysis' }}
                </div>
              </div>
            </div>

            <mat-divider></mat-divider>

            <div class="tracking-section">
              <h3>Tracking Parameters</h3>

              <!-- Hashtags -->
              @if (campaign()?.hashtags?.length) {
                <div class="tracking-group">
                  <h4><mat-icon>tag</mat-icon> Hashtags</h4>
                  <div class="chips-container">
                    @for (hashtag of campaign()?.hashtags; track hashtag) {
                      <span class="hashtag-chip">#{{ hashtag }}</span>
                    }
                  </div>
                </div>
              }

              <!-- Keywords -->
              @if (campaign()?.keywords?.length) {
                <div class="tracking-group">
                  <h4><mat-icon>search</mat-icon> Keywords</h4>
                  <div class="chips-container">
                    @for (keyword of campaign()?.keywords; track keyword) {
                      <span class="keyword-chip">{{ keyword }}</span>
                    }
                  </div>
                </div>
              }

              <!-- Mentions -->
              @if (campaign()?.mentions?.length) {
                <div class="tracking-group">
                  <h4><mat-icon>alternate_email</mat-icon> Mentions</h4>
                  <div class="chips-container">
                    @for (mention of campaign()?.mentions; track mention) {
                      <span class="mention-chip">{{ '@' + mention }}</span>
                    }
                  </div>
                </div>
              }
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Tweets Section -->
      <mat-card class="tweets-section-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>article</mat-icon>
            Campaign Tweets
          </mat-card-title>
          <mat-card-subtitle>
            Analysis of tweets collected for this campaign
          </mat-card-subtitle>
          <div class="section-actions">
            <button 
              mat-icon-button 
              matTooltip="Refresh Tweets" 
              (click)="refreshTweets()"
              [disabled]="tweetsLoading()">
              <mat-icon>refresh</mat-icon>
            </button>
          </div>
        </mat-card-header>

        <mat-card-content>
          <!-- Tweets Loading State -->
          @if (tweetsLoading()) {
            <div class="tweets-loading">
              <mat-progress-bar mode="indeterminate"></mat-progress-bar>
              <p>Loading tweets...</p>
            </div>
          }

          <!-- Tweets Error State -->
          @if (tweetsError()) {
            <div class="tweets-error">
              <mat-icon color="warn">error</mat-icon>
              <p>Error loading tweets: {{ tweetsError() }}</p>
              <button mat-raised-button color="primary" (click)="refreshTweets()">
                Try Again
              </button>
            </div>
          }

          <!-- Tweets Table -->
          @if (!tweetsLoading() && !tweetsError()) {
            @if (tweets().length > 0) {
              <div class="tweets-table-container">
                <app-solid-data-table-rxjs
                  [data]="tweets()"
                  [columns]="tweetTableColumns"
                  [config]="tweetTableConfig"
                  [actions]="tweetTableActions"
                  [loading]="tweetsLoading()"
                  [error]="tweetsError()"
                  (rowClick)="onTweetRowClick($event)"
                  (actionClick)="onTweetAction($event)"
                  (pageChange)="onTweetPageChange($event)"
                ></app-solid-data-table-rxjs>
              </div>
            } @else {
              <div class="no-tweets">
                <mat-icon class="no-data-icon">sentiment_neutral</mat-icon>
                <h3>No Tweets Found</h3>
                <p>This campaign doesn't have any tweets yet.</p>
                <p>
                  <button mat-raised-button color="primary" (click)="runScraping()" [disabled]="isScrapingRunning()">
                    <mat-icon>play_arrow</mat-icon>
                    Start Scraping
                  </button>
                </p>
              </div>
            }
          }
        </mat-card-content>
      </mat-card>
    </div>
  }
</div>