<div class="scraping-monitor-container">
  <!-- Header -->
  <div class="monitor-header">
    <h1>
      <mat-icon>monitor</mat-icon>
      Scraping Monitor
    </h1>
    <p>Real-time monitoring of your data collection campaigns</p>
  </div>

  <!-- WebSocket Testing Section -->
  <mat-card class="websocket-test-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>wifi</mat-icon>
        WebSocket Async Scraping Test
      </mat-card-title>
      <div class="connection-status">
        @if (isWebSocketConnected()) {
        <mat-chip class="status-connected">
          <mat-icon>check_circle</mat-icon>
          Connected
        </mat-chip>
        } @else {
        <mat-chip class="status-disconnected">
          <mat-icon>error</mat-icon>
          Disconnected
        </mat-chip>
        }
      </div>
    </mat-card-header>

    <mat-card-content>
      <!-- Quick Test Form -->
      <form [formGroup]="testForm" (ngSubmit)="startAsyncScrapingTest()" class="test-form">
        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Campaign ID</mat-label>
            <input matInput formControlName="campaignId" placeholder="test-campaign-001" />
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Hashtag</mat-label>
            <input matInput formControlName="hashtag" placeholder="javascript" />
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Max Tweets</mat-label>
            <mat-select formControlName="maxTweets">
              <mat-option value="25">25 (Sync)</mat-option>
              <mat-option value="75">75 (Async)</mat-option>
              <mat-option value="150">150 (Async)</mat-option>
              <mat-option value="300">300 (Async)</mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <div class="form-actions">
          <button
            mat-raised-button
            color="primary"
            type="submit"
            [disabled]="!isWebSocketConnected() || isTestRunning()"
          >
            @if (isTestRunning()) {
              <ng-container>
                <mat-icon>hourglass_empty</mat-icon>
                Testing...
              </ng-container>
            } @else {
              <ng-container>
                <mat-icon>rocket_launch</mat-icon>
                Start Async Test
              </ng-container>
            }
          </button>

          @if (!isWebSocketConnected()) {
          <button mat-button color="accent" (click)="connectWebSocket()">
            <mat-icon>wifi</mat-icon>
            Connect WebSocket
          </button>
          }
        </div>
      </form>

      <!-- Current Progress -->
      @if (currentProgress()) {
      <div class="progress-section">
        <h4>üìä Current Progress: {{ currentProgress()?.campaignId }}</h4>
        <div class="progress-details">
          <div class="progress-bar-container">
            <mat-progress-bar
              [value]="currentProgress()?.percentage || 0"
              color="primary"
              mode="determinate"
            >
            </mat-progress-bar>
            <span class="progress-text">{{ currentProgress()?.percentage || 0 }}%</span>
          </div>
          <div class="progress-info">
            <p><strong>Status:</strong> {{ currentProgress()?.status }}</p>
            <p><strong>Message:</strong> {{ currentProgress()?.message }}</p>
            <p>
              <strong>Tweets:</strong> {{ currentProgress()?.scrapedTweets }}/{{
                currentProgress()?.totalTweets
              }}
            </p>
            @if (currentProgress()?.estimatedTimeRemaining) {
            <p>
              <strong>ETA:</strong>
              {{ formatTimeRemaining(currentProgress()?.estimatedTimeRemaining) }}
            </p>
            }
          </div>
        </div>
      </div>
      }

      <!-- Completed Jobs -->
      @if (completedJobs().length > 0) {
      <div class="completed-section">
        <h4>‚úÖ Completed Jobs ({{ completedJobs().length }})</h4>
        <div class="jobs-list">
          @for (job of completedJobs(); track job.sessionId) {
          <div class="job-card">
            <div class="job-header">
              <strong>{{ job.campaignId }}</strong>
              <mat-chip class="job-status">{{ job.tweetsCount }} tweets</mat-chip>
            </div>
            <div class="job-details">
              <span>Completed: {{ formatTime(job.completedAt) }}</span>
              <span>Duration: {{ calculateDuration(job) }}</span>
            </div>
            @if (job.summary.sentimentBreakdown) {
            <div class="sentiment-breakdown">
              <small>
                üòä {{ job.summary.sentimentBreakdown.positive }} üòê
                {{ job.summary.sentimentBreakdown.neutral }} üòû
                {{ job.summary.sentimentBreakdown.negative }}
              </small>
            </div>
            }
          </div>
          }
        </div>
      </div>
      }
    </mat-card-content>
  </mat-card>

  <!-- Metrics Overview -->
  <div class="metrics-grid">
    <mat-card class="metric-card">
      <mat-card-content>
        <div class="metric-content">
          <mat-icon class="metric-icon total">campaign</mat-icon>
          <div class="metric-data">
            <span class="metric-value">{{ metrics().totalCampaigns }}</span>
            <span class="metric-label">Total Campaigns</span>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="metric-card">
      <mat-card-content>
        <div class="metric-content">
          <mat-icon class="metric-icon active">play_circle</mat-icon>
          <div class="metric-data">
            <span class="metric-value">{{ metrics().activeCampaigns }}</span>
            <span class="metric-label">Active Now</span>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="metric-card">
      <mat-card-content>
        <div class="metric-content">
          <mat-icon class="metric-icon tweets">trending_up</mat-icon>
          <div class="metric-data">
            <span class="metric-value">{{ formatNumber(metrics().totalTweets) }}</span>
            <span class="metric-label">Tweets Collected</span>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="metric-card">
      <mat-card-content>
        <div class="metric-content">
          <mat-icon class="metric-icon sentiment">sentiment_satisfied</mat-icon>
          <div class="metric-data">
            <span class="metric-value">{{ formatSentiment(metrics().averageSentiment) }}</span>
            <span class="metric-label">Avg Sentiment</span>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Active Campaigns -->
  <mat-card class="campaigns-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>list</mat-icon>
        Active Campaigns
      </mat-card-title>
      <div class="header-actions">
        <button mat-icon-button [disabled]="isRefreshing()" (click)="refreshData()">
          <mat-icon [class.spinning]="isRefreshing()">refresh</mat-icon>
        </button>
        <button mat-raised-button color="primary" (click)="startNewCampaign()">
          <mat-icon>add</mat-icon>
          New Campaign
        </button>
      </div>
    </mat-card-header>

    <mat-card-content>
      @if (campaigns().length === 0) {
      <div class="empty-state">
        <mat-icon>inbox</mat-icon>
        <h3>No Active Campaigns</h3>
        <p>Start a new campaign to begin monitoring social media data</p>
        <button mat-raised-button color="primary" (click)="startNewCampaign()">
          Create Campaign
        </button>
      </div>
      } @else {
      <div class="campaigns-list">
        @for (campaign of campaigns(); track campaign.id) {
        <div class="campaign-item">
          <div class="campaign-info">
            <div class="campaign-header">
              <h3>{{ campaign.name }}</h3>
              <mat-chip [class]="'status-' + campaign.status">
                {{ getStatusLabel(campaign.status) }}
              </mat-chip>
            </div>

            <div class="campaign-details">
              <span class="detail-item">
                <mat-icon>schedule</mat-icon>
                Started: {{ formatTime(campaign.startTime) }}
              </span>

              @if (campaign.estimatedCompletion) {
              <span class="detail-item">
                <mat-icon>timer</mat-icon>
                ETA: {{ formatTime(campaign.estimatedCompletion) }}
              </span>
              }

              <span class="detail-item">
                <mat-icon>trending_up</mat-icon>
                {{ formatNumber(campaign.tweetsCollected) }} tweets
              </span>

              <span class="detail-item">
                <mat-icon>sentiment_satisfied</mat-icon>
                {{ formatSentiment(campaign.sentimentScore) }}
              </span>
            </div>
          </div>

          <div class="campaign-progress">
            <div class="progress-info">
              <span class="progress-label">Progress</span>
              <span class="progress-value">{{ campaign.progress }}%</span>
            </div>
            <mat-progress-bar
              [value]="campaign.progress"
              [color]="getProgressColor(campaign.status)"
              mode="determinate"
            >
            </mat-progress-bar>
          </div>

          <div class="campaign-actions">
            @if (campaign.status === 'running') {
            <button mat-icon-button color="warn" (click)="pauseCampaign(campaign.id)" title="Pause">
              <mat-icon>pause</mat-icon>
            </button>
            } @else if (campaign.status === 'paused') {
            <button
              mat-icon-button
              color="primary"
              (click)="resumeCampaign(campaign.id)"
              title="Resume"
            >
              <mat-icon>play_arrow</mat-icon>
            </button>
            }

            <button mat-icon-button (click)="viewCampaignDetails(campaign.id)" title="View Details">
              <mat-icon>visibility</mat-icon>
            </button>

            <button mat-icon-button color="warn" (click)="stopCampaign(campaign.id)" title="Stop">
              <mat-icon>stop</mat-icon>
            </button>
          </div>
        </div>
        }
      </div>
      }
    </mat-card-content>
  </mat-card>

  <!-- Real-time Updates -->
  @if (hasActiveCampaigns()) {
  <mat-card class="updates-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>update</mat-icon>
        Live Updates
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="live-indicator">
        <div class="pulse-dot"></div>
        <span>Monitoring {{ activeCampaignsCount() }} active campaigns</span>
      </div>
    </mat-card-content>
  </mat-card>
  }
</div>
