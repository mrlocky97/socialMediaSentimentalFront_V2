<h2 mat-dialog-title>
  <mat-icon aria-hidden="true">campaign</mat-icon>
  Crear campaña
</h2>

<mat-dialog-content class="dialog-content" [formGroup]="form">
  <!-- Barra de envío -->
  @if (isSubmitting()) {
  <mat-progress-bar mode="indeterminate"></mat-progress-bar>
  }

  <!-- Información básica -->
  <section class="section">
    <h3><mat-icon>info</mat-icon> Información básica</h3>
    <div class="grid grid-2">
      <mat-form-field appearance="outline" class="full">
        <mat-label>Nombre</mat-label>
        <input matInput formControlName="name" autocomplete="off" maxlength="100" />
        <mat-hint align="end">{{ form.get('name')?.value?.length || 0 }}/100</mat-hint>
        @if (form.get('name')?.touched && form.get('name')?.invalid) {
        <mat-error>
          @if (form.get('name')?.errors?.['required']) { Requerido. } @if
          (form.get('name')?.errors?.['minlength']) { Mínimo 3 caracteres. }
        </mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="outline" class="full">
        <mat-label>Tipo</mat-label>
        <mat-select formControlName="type">
          @for (opt of typeOptions; track opt.value) {
          <mat-option [value]="opt.value">
            <mat-icon>{{ opt.icon }}</mat-icon
            >&nbsp;{{ opt.label }}
          </mat-option>
          }
        </mat-select>
        @if (form.get('type')?.touched && form.get('type')?.invalid) {
        <mat-error>Selecciona un tipo.</mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="outline" class="full" style="grid-column: 1 / -1">
        <mat-label>Descripción</mat-label>
        <textarea matInput formControlName="description" rows="3" maxlength="500"></textarea>
        <mat-hint align="end">{{ form.get('description')?.value?.length || 0 }}/500</mat-hint>
        @if (form.get('description')?.touched && form.get('description')?.invalid) {
        <mat-error>
          @if (form.get('description')?.errors?.['required']) { Requerido. } @if
          (form.get('description')?.errors?.['minlength']) { Mínimo 10 caracteres. }
        </mat-error>
        }
      </mat-form-field>
    </div>
  </section>

  <!-- Targeting -->
  <section class="section">
    <h3><mat-icon>tag</mat-icon> Targeting</h3>

    <!-- Hashtags -->
    <mat-card class="mb-8">
      <mat-card-header>
        <mat-card-title><mat-icon>tag</mat-icon> Hashtags</mat-card-title>
        <mat-card-subtitle>Ej: SummerVibes, BrandName</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        @if (hashtags.controls.length === 0) {
        <p class="hint">No has agregado hashtags todavía.</p>
        } @for (ctrl of hashtags.controls; track $index) {
        <div class="row">
          <mat-form-field appearance="outline" class="full">
            <mat-label>Hashtag {{ $index + 1 }}</mat-label>
            <input matInput [formControlName]="$index" placeholder="BrandName" />
            @if (ctrl.touched && ctrl.invalid) {
            <mat-error>Requerido (máx 100 caracteres)</mat-error>
            }
          </mat-form-field>
          <button
            mat-icon-button
            color="warn"
            type="button"
            aria-label="Eliminar hashtag"
            (click)="removeControl(hashtags, $index)"
          >
            <mat-icon>remove_circle</mat-icon>
          </button>
        </div>
        }
        <button mat-stroked-button type="button" (click)="addControl(hashtags)">
          <mat-icon>add</mat-icon> Agregar hashtag
        </button>
      </mat-card-content>
    </mat-card>

    <!-- Keywords -->
    <mat-card class="mb-8">
      <mat-card-header>
        <mat-card-title><mat-icon>search</mat-icon> Keywords</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        @if (keywords.controls.length === 0) {
        <p class="hint">Opcional: palabras clave para ampliar el alcance.</p>
        } @for (ctrl of keywords.controls; track $index) {
        <div class="row">
          <mat-form-field appearance="outline" class="full">
            <mat-label>Keyword {{ $index + 1 }}</mat-label>
            <input matInput [formControlName]="$index" />
            @if (ctrl.touched && ctrl.invalid) {
            <mat-error>Requerido (máx 100 caracteres)</mat-error>
            }
          </mat-form-field>
          <button
            mat-icon-button
            color="warn"
            type="button"
            aria-label="Eliminar keyword"
            (click)="removeControl(keywords, $index)"
          >
            <mat-icon>remove_circle</mat-icon>
          </button>
        </div>
        }
        <button mat-stroked-button type="button" (click)="addControl(keywords)">
          <mat-icon>add</mat-icon> Agregar keyword
        </button>
      </mat-card-content>
    </mat-card>

    <!-- Mentions -->
    <mat-card>
      <mat-card-header>
        <mat-card-title><mat-icon>alternate_email</mat-icon> Mentions</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        @if (mentions.controls.length === 0) {
        <p class="hint">Opcional: usuarios o cuentas relevantes.</p>
        } @for (ctrl of mentions.controls; track $index) {
        <div class="row">
          <mat-form-field appearance="outline" class="full">
            <mat-label>Mención {{ $index + 1 }}</mat-label>
            <input matInput [formControlName]="$index" placeholder="@brand" />
            @if (ctrl.touched && ctrl.invalid) {
            <mat-error>Requerido (máx 100 caracteres)</mat-error>
            }
          </mat-form-field>
          <button
            mat-icon-button
            color="warn"
            type="button"
            aria-label="Eliminar mención"
            (click)="removeControl(mentions, $index)"
          >
            <mat-icon>remove_circle</mat-icon>
          </button>
        </div>
        }
        <button mat-stroked-button type="button" (click)="addControl(mentions)">
          <mat-icon>add</mat-icon> Agregar mención
        </button>
      </mat-card-content>
    </mat-card>

    @if (form.errors?.['noTargeting'] && (hashtags.touched || keywords.touched || mentions.touched))
    {
    <div class="error-box" style="margin-top: 8px">
      Debes agregar al menos un hashtag, keyword o mención.
    </div>
    }
  </section>

  <!-- Configuración y fuentes -->
  <section class="section">
    <h3><mat-icon>settings</mat-icon> Configuración</h3>

    <div class="grid grid-3">
      <mat-form-field appearance="outline" class="full">
        <mat-label>Fecha de inicio</mat-label>
        <input matInput type="datetime-local" formControlName="startDateLocal" />
        @if (form.get('startDateLocal')?.touched && form.get('startDateLocal')?.invalid) {
        <mat-error>Requerido.</mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="outline" class="full">
        <mat-label>Fecha de fin</mat-label>
        <input matInput type="datetime-local" formControlName="endDateLocal" />
        @if (form.get('endDateLocal')?.touched && form.get('endDateLocal')?.invalid) {
        <mat-error>Requerido.</mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="outline" class="full">
        <mat-label>Zona horaria</mat-label>
        <mat-select formControlName="timezone">
          <mat-option value="UTC">UTC</mat-option>
          <mat-option value="Europe/Zurich">Europe/Zurich</mat-option>
          <mat-option value="America/New_York">America/New_York</mat-option>
          <mat-option value="Europe/Madrid">Europe/Madrid</mat-option>
        </mat-select>
        @if (form.get('timezone')?.touched && form.get('timezone')?.invalid) {
        <mat-error>Requerido.</mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="outline" class="full">
        <mat-label>Máximo de tweets</mat-label>
        <input
          matInput
          type="number"
          formControlName="maxTweets"
          min="100"
          max="10000"
          step="100"
        />
        <mat-hint>Entre 100 y 10.000</mat-hint>
        @if (form.get('maxTweets')?.touched && form.get('maxTweets')?.invalid) {
        <mat-error>
          @if (form.get('maxTweets')?.errors?.['min']) { Mínimo 100. } @if
          (form.get('maxTweets')?.errors?.['max']) { Máximo 10.000. } @if
          (form.get('maxTweets')?.errors?.['required']) { Requerido. }
        </mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="outline" class="full" style="grid-column: 1 / -1">
        <mat-label>Fuentes de datos</mat-label>
        <mat-select formControlName="dataSources" multiple>
          @for (src of dataSourceOptions; track src.value) {
          <mat-option [value]="src.value">{{ src.label }}</mat-option>
          }
        </mat-select>
        <mat-hint>Selecciona al menos una</mat-hint>
        @if (form.get('dataSources')?.touched && form.get('dataSources')?.invalid) {
        <mat-error>Selecciona al menos una fuente.</mat-error>
        }
        <div class="chips-row" style="margin-top: 6px">
          @for (v of form.get('dataSources')?.value || []; track v) {
          <mat-chip>{{ v }}</mat-chip>
          }
        </div>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full" style="grid-column: 1 / -1">
        <mat-label>Idiomas</mat-label>
        <mat-select formControlName="languages" multiple>
          @for (code of languageOptions; track code) {
          <mat-option [value]="code">{{ code }}</mat-option>
          }
        </mat-select>
        <mat-hint>Opcional</mat-hint>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full" style="grid-column: 1 / -1">
        <mat-label>Organization ID</mat-label>
        <input matInput formControlName="organizationId" />
        @if (form.get('organizationId')?.touched && form.get('organizationId')?.invalid) {
        <mat-error>Requerido.</mat-error>
        }
      </mat-form-field>

      <div class="grid grid-auto" style="grid-column: 1 / -1">
        <mat-card>
          <mat-card-content class="grid grid-auto">
            <mat-checkbox formControlName="collectImages"
              ><mat-icon>image</mat-icon>&nbsp;Guardar imágenes</mat-checkbox
            >
            <mat-checkbox formControlName="collectVideos"
              ><mat-icon>movie</mat-icon>&nbsp;Guardar videos</mat-checkbox
            >
            <mat-checkbox formControlName="collectReplies"
              ><mat-icon>chat_bubble</mat-icon>&nbsp;Incluir respuestas</mat-checkbox
            >
            <mat-checkbox formControlName="collectRetweets"
              ><mat-icon>repeat</mat-icon>&nbsp;Incluir retweets</mat-checkbox
            >
          </mat-card-content>
        </mat-card>

        <mat-card>
          <mat-card-content class="grid grid-auto">
            <mat-checkbox formControlName="sentimentAnalysis">
              <mat-icon>sentiment_satisfied</mat-icon>&nbsp;Análisis de sentimiento
            </mat-checkbox>
            <mat-checkbox formControlName="emotionAnalysis"
              ><mat-icon>favorite</mat-icon>&nbsp;Emoción</mat-checkbox
            >
            <mat-checkbox formControlName="topicsAnalysis"
              ><mat-icon>topic</mat-icon>&nbsp;Tópicos</mat-checkbox
            >
            <mat-checkbox formControlName="influencerAnalysis"
              ><mat-icon>groups</mat-icon>&nbsp;Influencers</mat-checkbox
            >
          </mat-card-content>
        </mat-card>
      </div>
    </div>

    @if (form.errors?.['dateRange']) {
    <div class="error-box" style="margin-top: 8px">
      La fecha de fin debe ser posterior a la fecha de inicio.
    </div>
    }
  </section>

  @if (submitError()) {
  <div class="error-box">{{ submitError() }}</div>
  }
</mat-dialog-content>

<mat-dialog-actions align="end">
  <button mat-stroked-button (click)="cancel()" [disabled]="isSubmitting()">Cancelar</button>
  <button
    mat-raised-button
    color="primary"
    (click)="submit()"
    [disabled]="isSubmitting() || form.invalid"
  >
    <mat-icon>campaign</mat-icon>&nbsp;Crear campaña
  </button>
</mat-dialog-actions>
