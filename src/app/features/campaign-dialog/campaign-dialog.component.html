<h2 mat-dialog-title>
  <mat-icon aria-hidden="true">campaign</mat-icon>
  {{ isEditMode ? ('campaign_dialog.edit_campaign' | transloco) : ('campaign_dialog.create_campaign' | transloco) }}
</h2>

<mat-dialog-content class="dialog-content" [formGroup]="form">
  <!-- Barra de envío -->
  @if (isSubmitting()) {
  <mat-progress-bar mode="indeterminate"></mat-progress-bar>
  }

  <!-- Información básica -->
  <section class="section">
    <h3><mat-icon>info</mat-icon> {{ 'campaign_dialog.basic_info' | transloco }}</h3>
    <div class="grid grid-2">
      <mat-form-field appearance="outline" class="full">
        <mat-label>{{ 'campaign_dialog.name' | transloco }}</mat-label>
        <input matInput formControlName="name" autocomplete="off" maxlength="100" />
        <mat-hint align="end">{{ form.get('name')?.value?.length || 0 }}/100</mat-hint>
        @if (form.get('name')?.touched && form.get('name')?.invalid) {
        <mat-error>
          @if (form.get('name')?.errors?.['required']) {
          {{ 'campaign_dialog.required' | transloco }} } @if
          (form.get('name')?.errors?.['minlength']) {
          {{ 'campaign_dialog.min_chars' | transloco : { chars: 3 } }} }
        </mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="outline" class="full">
        <mat-label>{{ 'campaign_dialog.type' | transloco }}</mat-label>
        <mat-select formControlName="type">
          @for (opt of typeOptions; track opt.value) {
          <mat-option [value]="opt.value">
            <mat-icon>{{ opt.icon }}</mat-icon
            >&nbsp;{{ opt.label }}
          </mat-option>
          }
        </mat-select>
        @if (form.get('type')?.touched && form.get('type')?.invalid) {
        <mat-error>{{ 'campaign_dialog.select_type' | transloco }}</mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="outline" class="full" style="grid-column: 1 / -1">
        <mat-label>{{ 'campaign_dialog.description' | transloco }}</mat-label>
        <textarea matInput formControlName="description" rows="3" maxlength="500"></textarea>
        <mat-hint align="end">{{ form.get('description')?.value?.length || 0 }}/500</mat-hint>
        @if (form.get('description')?.touched && form.get('description')?.invalid) {
        <mat-error>
          @if (form.get('description')?.errors?.['required']) {
          {{ 'campaign_dialog.required' | transloco }} } @if
          (form.get('description')?.errors?.['minlength']) {
          {{ 'campaign_dialog.min_chars' | transloco : { chars: 10 } }} }
        </mat-error>
        }
      </mat-form-field>
    </div>
  </section>

  <!-- Targeting -->
  <section class="section">
    <h3><mat-icon>tag</mat-icon> {{ 'campaign_dialog.targeting' | transloco }}</h3>

    <!-- Hashtags -->
    <mat-card class="mb-8">
      <mat-card-header>
        <mat-card-title
          ><mat-icon>tag</mat-icon> {{ 'campaign_dialog.hashtags' | transloco }}</mat-card-title
        >
        <mat-card-subtitle>{{ 'campaign_dialog.hashtags_example' | transloco }}</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content formArrayName="hashtags">
        @if (hashtags.controls.length === 0) {
        <p class="hint">{{ 'campaign_dialog.no_hashtags_added' | transloco }}</p>
        } @for (ctrl of hashtags.controls; track $index) {
        <div class="row">
          <mat-form-field appearance="outline" class="full">
            <mat-label>{{ 'campaign_dialog.hashtag' | transloco }} {{ $index + 1 }}</mat-label>
            <input matInput [formControlName]="$index" placeholder="BrandName" />
            @if (ctrl.touched && ctrl.invalid) {
            <mat-error>
              {{ 'campaign_dialog.required_max_chars' | transloco : { chars: 100 } }}
            </mat-error>
            }
          </mat-form-field>
          <button
            mat-icon-button
            color="warn"
            type="button"
            [attr.aria-label]="transloco.translate('campaign_dialog.remove_hashtag')"
            (click)="removeControl(hashtags, $index)"
          >
            <mat-icon>remove_circle</mat-icon>
          </button>
        </div>
        }
        <button mat-stroked-button type="button" (click)="addControl(hashtags)">
          <mat-icon>add</mat-icon> {{ 'campaign_dialog.add_hashtag' | transloco }}
        </button>
      </mat-card-content>
    </mat-card>

    <!-- Keywords -->
    <mat-card class="mb-8">
      <mat-card-header>
        <mat-card-title
          ><mat-icon>search</mat-icon> {{ 'campaign_dialog.keywords' | transloco }}</mat-card-title
        >
      </mat-card-header>
      <mat-card-content formArrayName="keywords">
        @if (keywords.controls.length === 0) {
        <p class="hint">{{ 'campaign_dialog.keywords_hint' | transloco }}</p>
        } @for (ctrl of keywords.controls; track $index) {
        <div class="row">
          <mat-form-field appearance="outline" class="full">
            <mat-label>{{ 'campaign_dialog.keyword' | transloco }} {{ $index + 1 }}</mat-label>
            <input matInput [formControlName]="$index" />
            @if (ctrl.touched && ctrl.invalid) {
            <mat-error>
              {{ 'campaign_dialog.required_max_chars' | transloco : { chars: 100 } }}
            </mat-error>
            }
          </mat-form-field>
          <button
            mat-icon-button
            color="warn"
            type="button"
            [attr.aria-label]="transloco.translate('campaign_dialog.remove_keyword')"
            (click)="removeControl(keywords, $index)"
          >
            <mat-icon>remove_circle</mat-icon>
          </button>
        </div>
        }
        <button mat-stroked-button type="button" (click)="addControl(keywords)">
          <mat-icon>add</mat-icon> {{ 'campaign_dialog.add_keyword' | transloco }}
        </button>
      </mat-card-content>
    </mat-card>

    <!-- Mentions -->
    <mat-card>
      <mat-card-header>
        <mat-card-title
          ><mat-icon>alternate_email</mat-icon>
          {{ 'campaign_dialog.mentions' | transloco }}</mat-card-title
        >
      </mat-card-header>
      <mat-card-content formArrayName="mentions">
        @if (mentions.controls.length === 0) {
        <p class="hint">{{ 'campaign_dialog.mentions_hint' | transloco }}</p>
        } @for (ctrl of mentions.controls; track $index) {
        <div class="row">
          <mat-form-field appearance="outline" class="full">
            <mat-label>{{ 'campaign_dialog.mention' | transloco }} {{ $index + 1 }}</mat-label>
            <input matInput [formControlName]="$index" placeholder="@brand" />
            @if (ctrl.touched && ctrl.invalid) {
            <mat-error>
              {{ 'campaign_dialog.required_max_chars' | transloco : { chars: 100 } }}
            </mat-error>
            }
          </mat-form-field>
          <button
            mat-icon-button
            color="warn"
            type="button"
            [attr.aria-label]="transloco.translate('campaign_dialog.remove_mention')"
            (click)="removeControl(mentions, $index)"
          >
            <mat-icon>remove_circle</mat-icon>
          </button>
        </div>
        }
        <button mat-stroked-button type="button" (click)="addControl(mentions)">
          <mat-icon>add</mat-icon> {{ 'campaign_dialog.add_mention' | transloco }}
        </button>
      </mat-card-content>
    </mat-card>

    @if (form.errors?.['noTargeting'] && (hashtags.touched || keywords.touched || mentions.touched))
    {
    <div class="error-box" style="margin-top: 8px">
      {{ 'campaign_dialog.targeting_error' | transloco }}
    </div>
    }
  </section>

  <!-- Configuración y fuentes -->
  <section class="section">
    <h3><mat-icon>settings</mat-icon> {{ 'campaign_dialog.configuration' | transloco }}</h3>

    <div class="grid grid-3">
      <mat-form-field appearance="outline" class="full">
        <mat-label>{{ 'campaign_dialog.start_date' | transloco }}</mat-label>
        <input matInput type="datetime-local" formControlName="startDateLocal" />
        @if (form.get('startDateLocal')?.touched && form.get('startDateLocal')?.invalid) {
        <mat-error>{{ 'campaign_dialog.required' | transloco }}</mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="outline" class="full">
        <mat-label>{{ 'campaign_dialog.end_date' | transloco }}</mat-label>
        <input matInput type="datetime-local" formControlName="endDateLocal" />
        @if (form.get('endDateLocal')?.touched && form.get('endDateLocal')?.invalid) {
        <mat-error>{{ 'campaign_dialog.required' | transloco }}</mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="outline" class="full">
        <mat-label>{{ 'campaign_dialog.timezone' | transloco }}</mat-label>
        <mat-select formControlName="timezone">
          <mat-option value="UTC">UTC</mat-option>
          <mat-option value="Europe/Zurich">Europe/Zurich</mat-option>
          <mat-option value="America/New_York">America/New_York</mat-option>
          <mat-option value="Europe/Madrid">Europe/Madrid</mat-option>
        </mat-select>
        @if (form.get('timezone')?.touched && form.get('timezone')?.invalid) {
        <mat-error>{{ 'campaign_dialog.required' | transloco }}</mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="outline" class="full">
        <mat-label>{{ 'campaign_dialog.max_tweets' | transloco }}</mat-label>
        <input matInput type="number" formControlName="maxTweets" min="100" max="1000" step="100" />
        <mat-hint>
          {{ 'campaign_dialog.between_values' | transloco : { min: 100, max: 10000 } }}
        </mat-hint>
        @if (form.get('maxTweets')?.touched && form.get('maxTweets') ?.invalid) {
        <mat-error>
          @if (form.get('maxTweets')?.errors?.['min']) {
          {{ 'campaign_dialog.min_value' | transloco : { value: 100 } }} } @if
          (form.get('maxTweets')?.errors?.['max']) {
          {{ 'campaign_dialog.max_value' | transloco : { value: 10000 } }} } @if
          (form.get('maxTweets')?.errors?.['required']) {
          {{ 'campaign_dialog.required' | transloco }} }
        </mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="outline" class="full" style="grid-column: 1 / -1">
        <mat-label>{{ 'campaign_dialog.data_sources' | transloco }}</mat-label>
        <mat-select formControlName="dataSources" multiple>
          @for (src of dataSourceOptions; track src.value) {
          <mat-option [value]="src.value">{{ src.label }}</mat-option>
          }
        </mat-select>
        <mat-hint>{{ 'campaign_dialog.select_at_least_one' | transloco }}</mat-hint>
        @if (form.get('dataSources')?.touched && form.get('dataSources')?.invalid) {
        <mat-error>{{ 'campaign_dialog.select_at_least_one_source' | transloco }}</mat-error>
        }
        <div class="chips-row" style="margin-top: 6px">
          @for (v of form.get('dataSources')?.value || []; track v) {
          <mat-chip>{{ v }}</mat-chip>
          }
        </div>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full" style="grid-column: 1 / -1">
        <mat-label>{{ 'campaign_dialog.languages' | transloco }}</mat-label>
        <mat-select formControlName="languages" multiple>
          @for (code of languageOptions; track code) {
          <mat-option [value]="code">{{ code }}</mat-option>
          }
        </mat-select>
        <mat-hint>{{ 'campaign_dialog.optional' | transloco }}</mat-hint>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full" style="grid-column: 1 / -1">
        <mat-label>{{ 'campaign_dialog.organization_id' | transloco }}</mat-label>
        <input matInput formControlName="organizationId" />
        @if (form.get('organizationId')?.touched && form.get('organizationId')?.invalid) {
        <mat-error>{{ 'campaign_dialog.required' | transloco }}</mat-error>
        }
      </mat-form-field>

      <div class="grid grid-auto" style="grid-column: 1 / -1">
        <mat-card>
          <mat-card-content class="grid grid-auto">
            <mat-checkbox formControlName="collectImages">
              <mat-icon>image</mat-icon>&nbsp;
              {{ 'campaign_dialog.collect_images' | transloco }}
            </mat-checkbox>
            <mat-checkbox formControlName="collectVideos">
              <mat-icon>movie</mat-icon>&nbsp;
              {{ 'campaign_dialog.collect_videos' | transloco }}
            </mat-checkbox>
            <mat-checkbox formControlName="collectReplies">
              <mat-icon>chat_bubble</mat-icon>&nbsp;
              {{ 'campaign_dialog.include_replies' | transloco }}
            </mat-checkbox>
            <mat-checkbox formControlName="collectRetweets">
              <mat-icon>repeat</mat-icon>&nbsp;
              {{ 'campaign_dialog.include_retweets' | transloco }}
            </mat-checkbox>
          </mat-card-content>
        </mat-card>

        <mat-card>
          <mat-card-content class="grid grid-auto">
            <mat-checkbox formControlName="sentimentAnalysis">
              <mat-icon>sentiment_satisfied</mat-icon>&nbsp;
              {{ 'campaign_dialog.sentiment_analysis' | transloco }}
            </mat-checkbox>
            <mat-checkbox formControlName="emotionAnalysis">
              <mat-icon>favorite</mat-icon>&nbsp;
              {{ 'campaign_dialog.emotion_analysis' | transloco }}
            </mat-checkbox>
            <mat-checkbox formControlName="topicsAnalysis">
              <mat-icon>topic</mat-icon>&nbsp;
              {{ 'campaign_dialog.topics_analysis' | transloco }}
            </mat-checkbox>
            <mat-checkbox formControlName="influencerAnalysis">
              <mat-icon>groups</mat-icon>&nbsp;
              {{ 'campaign_dialog.influencer_analysis' | transloco }}
            </mat-checkbox>
          </mat-card-content>
        </mat-card>
      </div>
    </div>

    @if (form.errors?.['dateRange']) {
    <div class="error-box" style="margin-top: 8px">
      {{ 'campaign_dialog.date_range_error' | transloco }}
    </div>
    }
  </section>

  @if (submitError()) {
  <div class="error-box">{{ submitError() }}</div>
  }
</mat-dialog-content>

<mat-dialog-actions align="end">
  <button mat-stroked-button (click)="cancel()" [disabled]="isSubmitting()">
    {{ 'campaign_dialog.cancel' | transloco }}
  </button>
  <button mat-raised-button color="primary" (click)="submit()">
    <mat-icon>{{ isEditMode ? 'update' : 'campaign' }}</mat-icon
    >&nbsp;{{
      isEditMode
        ? ('campaign_dialog.update_campaign' | transloco)
        : ('campaign_dialog.create_campaign' | transloco)
    }}
  </button>
</mat-dialog-actions>
