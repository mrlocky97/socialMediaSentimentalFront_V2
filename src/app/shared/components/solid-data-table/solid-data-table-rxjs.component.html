<div class="table-container">
  <!-- Table Header with Controls -->
  <div class="table-header" *ngIf="config.showSearch || hasFilters()">
    <div class="search-controls">
      <mat-form-field appearance="outline" *ngIf="config.showSearch">
        <mat-label>Search</mat-label>
        <input
          matInput
          [value]="currentSearchTerm()"
          (input)="onSearchChange($event)"
          placeholder="Search in table..."
        />
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>

      <button mat-button *ngIf="hasFilters()" (click)="clearAllFilters()" color="warn">
        <mat-icon>clear</mat-icon>
        Clear Filters
      </button>
    </div>

    <!-- Table Stats -->
    <div class="table-stats">
      <span class="item-count"> {{ filteredItemCount() }} of {{ totalItemCount() }} items </span>
      <span class="selection-count" *ngIf="hasSelection()">
        ({{ getSelectionCount() }} selected)
      </span>
    </div>
  </div>

  <!-- Loading Indicator -->
  <div class="loading-container" *ngIf="isLoading()">
    <mat-spinner diameter="40"></mat-spinner>
    <span>Loading...</span>
  </div>

  <!-- Error Display -->
  <div class="error-container" *ngIf="hasError()" class="error-message">
    <mat-icon color="warn">error</mat-icon>
    <span>{{ errorMessage() }}</span>
    <button mat-button (click)="refreshData()" color="primary">
      <mat-icon>refresh</mat-icon>
      Retry
    </button>
  </div>

  <!-- Data Table -->
  <div class="table-wrapper" *ngIf="!isLoading() && !hasError()">
    <table
      mat-table
      [dataSource]="getDataSource()"
      matSort
      (matSortChange)="onSortChange($event)"
      class="full-width"
    >
      <!-- Selection Column -->
      <ng-container matColumnDef="select" *ngIf="config.showSelection">
        <th mat-header-cell *matHeaderCellDef>
          <mat-checkbox
            *ngIf="config.multiSelection"
            [checked]="isAllSelected()"
            [indeterminate]="isPartiallySelected()"
            (change)="toggleAllSelection()"
          >
          </mat-checkbox>
        </th>
        <td mat-cell *matCellDef="let row">
          <mat-checkbox
            [checked]="isRowSelected(row)"
            (click)="$event.stopPropagation()"
            (change)="toggleRowSelection(row)"
          >
          </mat-checkbox>
        </td>
      </ng-container>

      <!-- Dynamic Data Columns -->
      <ng-container *ngFor="let column of columns" [matColumnDef]="column.key">
        <th
          mat-header-cell
          *matHeaderCellDef
          [mat-sort-header]="column.sortable !== false ? column.key : ''"
          [style.width]="column.width"
          [style.text-align]="column.align || 'left'"
        >
          {{ column.label }}
        </th>
        <td
          mat-cell
          *matCellDef="let element"
          [style.text-align]="column.align || 'left'"
          (click)="onRowClick(element)"
        >
          {{ getFormattedValue(element, column) }}
        </td>
      </ng-container>

      <!-- Actions Column -->
      <ng-container matColumnDef="actions" *ngIf="actions.length > 0">
        <th mat-header-cell *matHeaderCellDef>Actions</th>
        <td mat-cell *matCellDef="let element">
          <button
            mat-icon-button
            *ngFor="let action of getVisibleActions(element)"
            [disabled]="isActionDisabled(action, element)"
            [color]="action.color"
            [title]="action.label"
            (click)="$event.stopPropagation(); executeAction(action, element)"
          >
            <mat-icon>{{ action.icon }}</mat-icon>
          </button>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns()"></tr>
      <tr
        mat-row
        *matRowDef="let row; columns: displayedColumns()"
        [class.selected]="isRowSelected(row)"
        (click)="onRowClick(row)"
      ></tr>
    </table>

    <!-- Paginator -->
    <mat-paginator
      *ngIf="config.showPagination"
      [length]="totalItemCount()"
      [pageSize]="config.pageSize || 10"
      [pageSizeOptions]="config.pageSizeOptions || [5, 10, 25, 50]"
      (page)="onPageChange($event)"
      showFirstLastButtons
    >
    </mat-paginator>
  </div>

  <!-- Selection Actions Bar -->
  <div class="selection-actions" *ngIf="hasSelection()">
    <span>{{ getSelectionCount() }} items selected</span>
    <button mat-button (click)="clearSelection()">Clear Selection</button>
    <button mat-raised-button color="primary" (click)="exportData()">
      <mat-icon>download</mat-icon>
      Export Selected
    </button>
  </div>
</div>
